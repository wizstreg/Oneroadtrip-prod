<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ORT - Test Import URL</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #1e3a5f 0%, #113f7a 100%);
    min-height: 100vh;
    padding: 20px;
  }
  .container {
    max-width: 800px;
    margin: 0 auto;
  }
  .card {
    background: #fff;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  }
  h1 {
    color: #fff;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  h2 {
    color: #113f7a;
    margin-bottom: 16px;
    font-size: 18px;
  }
  .status-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  .status-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: #f1f5f9;
    border-radius: 8px;
    font-size: 14px;
  }
  .status-item.ok { background: #dcfce7; color: #166534; }
  .status-item.error { background: #fee2e2; color: #dc2626; }
  .status-item.pending { background: #fef3c7; color: #92400e; }
  
  .btn {
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn-primary {
    background: #113f7a;
    color: #fff;
  }
  .btn-primary:hover { background: #0d2f5e; }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
  
  .btn-outline {
    background: #fff;
    color: #113f7a;
    border: 2px solid #113f7a;
  }
  .btn-outline:hover { background: #f0f4f8; }
  
  .btn-danger {
    background: #dc2626;
    color: #fff;
  }
  .btn-danger:hover { background: #b91c1c; }
  
  .test-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
  }
  
  .test-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }
  
  .log-box {
    background: #1e293b;
    color: #e2e8f0;
    border-radius: 10px;
    padding: 16px;
    font-family: 'Consolas', monospace;
    font-size: 13px;
    max-height: 300px;
    overflow-y: auto;
  }
  .log-box .log-entry {
    margin-bottom: 6px;
    padding-bottom: 6px;
    border-bottom: 1px solid #334155;
  }
  .log-box .log-entry:last-child { border-bottom: none; }
  .log-box .time { color: #64748b; }
  .log-box .success { color: #4ade80; }
  .log-box .error { color: #f87171; }
  .log-box .info { color: #60a5fa; }
  
  .user-info {
    display: none;
    padding: 12px;
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    margin-bottom: 16px;
  }
  .user-info.visible { display: block; }
  
  .auth-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .input-group {
    margin-bottom: 12px;
  }
  .input-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: #334155;
  }
  .input-group input {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
  }
  .input-group input:focus {
    outline: none;
    border-color: #113f7a;
  }

  /* === MODAL STYLES === */
  .ort-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
  }
  .ort-modal.active { display: flex; }

  .ort-modal-card {
    position: relative;
    width: 100%;
    max-width: 480px;
    background: #fff;
    border-radius: 16px;
    padding: 28px;
    box-shadow: 0 20px 60px rgba(0,0,0,.25);
    animation: ortSlideUp 0.3s ease;
  }

  @keyframes ortSlideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .ort-modal-close {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 32px;
    height: 32px;
    border: none;
    background: #f1f5f9;
    border-radius: 50%;
    font-size: 20px;
    color: #64748b;
    cursor: pointer;
  }
  .ort-modal-close:hover {
    background: #e2e8f0;
    color: #334155;
  }

  .ort-modal-card h3 {
    margin: 0 0 8px;
    color: #113f7a;
    font-size: 20px;
  }

  .ort-hint {
    font-size: 14px;
    color: #64748b;
    margin-bottom: 16px;
  }

  .ort-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 15px;
  }
  .ort-input:focus {
    outline: none;
    border-color: #113f7a;
  }

  .ort-status {
    display: none;
    margin-top: 12px;
    padding: 12px 14px;
    border-radius: 10px;
    font-size: 14px;
  }
  .ort-status.loading { display: block; background: #fef3c7; color: #92400e; }
  .ort-status.error { display: block; background: #fee2e2; color: #dc2626; }
  .ort-status.success { display: block; background: #dcfce7; color: #166534; }

  .ort-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  .ort-btn {
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: none;
  }

  .ort-btn.outline {
    background: #fff;
    color: #113f7a;
    border: 2px solid #113f7a;
  }
  .ort-btn.outline:hover { background: #f0f4f8; }

  .ort-btn.primary {
    background: #113f7a;
    color: #fff;
    border: 2px solid #113f7a;
  }
  .ort-btn.primary:hover {
    background: #0d2f5e;
    border-color: #0d2f5e;
  }
  .ort-btn:disabled { opacity: 0.6; cursor: not-allowed; }

  .ort-quota {
    margin-top: 16px;
    text-align: center;
    font-size: 12px;
    color: #94a3b8;
  }

  /* === FALLBACK MODAL === */
  .ort-modal-card.fallback {
    max-width: 520px;
    text-align: center;
  }

  .fallback-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }

  .ort-modal-card.fallback h3 {
    color: #0369a1;
    font-size: 22px;
    margin-bottom: 16px;
  }

  .fallback-explain {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 10px;
    padding: 14px 16px;
    font-size: 14px;
    color: #0c4a6e;
    margin-bottom: 20px;
  }

  .fallback-solution {
    text-align: left;
    background: #f8fafc;
    border-radius: 10px;
    padding: 16px 20px;
    margin-bottom: 20px;
  }

  .fallback-solution h4 {
    margin: 0 0 12px;
    font-size: 15px;
    color: #334155;
  }

  .fallback-solution ol {
    margin: 0;
    padding-left: 20px;
  }

  .fallback-solution li {
    font-size: 14px;
    color: #475569;
    margin-bottom: 8px;
  }

  .fallback-solution kbd {
    background: #e2e8f0;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
  }

  .fallback-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .fallback-error {
    margin-top: 16px;
    font-size: 11px;
    color: #94a3b8;
    font-family: monospace;
  }

  @media (max-width: 540px) {
    .ort-modal-card { padding: 20px; }
    .ort-actions, .fallback-actions { flex-direction: column; }
    .ort-btn { width: 100%; justify-content: center; }
  }
</style>
</head>
<body>

<div class="container">
  <h1>üß™ Test Import URL - Preprod</h1>
  
  <!-- Auth Status -->
  <div class="card">
    <h2>üîê Authentification Firebase</h2>
    
    <div class="status-bar" id="authStatus">
      <div class="status-item pending" id="firebaseStatus">‚è≥ Firebase...</div>
      <div class="status-item pending" id="userStatus">‚è≥ User...</div>
    </div>
    
    <div class="user-info" id="userInfo">
      <strong>Connect√© :</strong> <span id="userEmail">-</span>
    </div>
    
    <div class="auth-buttons" style="margin-top: 16px;">
      <button class="btn btn-primary" id="btnLogin" disabled>üìß Connexion Email</button>
      <button class="btn btn-danger" id="btnLogout" style="display:none">üö™ D√©connexion</button>
    </div>
    
    <!-- Login Form (hidden by default) -->
    <div id="loginForm" style="display:none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
      <div class="input-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="votre@email.com">
      </div>
      <div class="input-group">
        <label>Mot de passe</label>
        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div style="display: flex; gap: 12px; margin-top: 12px;">
        <button class="btn btn-primary" id="btnDoLogin">Se connecter</button>
        <button class="btn btn-outline" id="btnCancelLogin">Annuler</button>
      </div>
    </div>
  </div>
  
  <!-- Test Import URL -->
  <div class="card">
    <h2>üîó Test Import URL</h2>
    
    <div class="test-buttons">
      <button class="btn btn-primary" id="btnImportUrl" disabled>
        üîó Importer depuis une URL
      </button>
      <button class="btn btn-outline" id="btnTestFallback" disabled>
        üß™ Tester Modal Fallback
      </button>
    </div>
    
    <div class="test-section">
      <h2>üìã Logs</h2>
      <div class="log-box" id="logBox">
        <div class="log-entry"><span class="time">[--:--:--]</span> En attente...</div>
      </div>
      <button class="btn btn-outline" id="btnClearLogs" style="margin-top: 12px;">üóëÔ∏è Effacer logs</button>
    </div>
  </div>
  
  <!-- Result Preview -->
  <div class="card" id="resultCard" style="display: none;">
    <h2>‚úÖ R√©sultat</h2>
    <pre id="resultJson" style="background: #f8fafc; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 12px; max-height: 400px;"></pre>
    <div style="margin-top: 16px; display: flex; gap: 12px;">
      <button class="btn btn-primary" id="btnGoDetail">üìç Ouvrir RT Detail</button>
      <button class="btn btn-outline" id="btnGoEditor">üìì Ouvrir Carnet</button>
    </div>
  </div>
</div>

<!-- ============================================
     MODAL 1: Import URL
     ============================================ -->
<div id="importUrlModal" class="ort-modal">
  <div class="ort-modal-card">
    <button class="ort-modal-close" id="btnCloseUrlModal">√ó</button>
    
    <h3>üîó Importer un itin√©raire</h3>
    <p class="ort-hint">Collez l'URL d'un article de voyage (blog, guide...)</p>
    
    <input type="url" id="importUrlInput" 
           placeholder="https://www.exemple.com/road-trip-islande" 
           class="ort-input">
    
    <div id="importUrlStatus" class="ort-status"></div>
    
    <div class="ort-actions">
      <button id="btnCancelUrl" class="ort-btn outline">Annuler</button>
      <button id="btnConfirmUrl" class="ort-btn primary">
        <span class="btn-text">Importer</span>
        <span class="btn-loader" style="display:none">‚è≥</span>
      </button>
    </div>
    
    <div id="urlQuotaInfo" class="ort-quota"></div>
  </div>
</div>

<!-- ============================================
     MODAL 2: Fallback
     ============================================ -->
<div id="importFallbackModal" class="ort-modal">
  <div class="ort-modal-card fallback">
    <button class="ort-modal-close" id="btnCloseFallback">√ó</button>
    
    <div class="fallback-icon">ü§ñüí®</div>
    <h3 id="fallbackTitle">Oups, l'IA a besoin d'une pause !</h3>
    
    <div class="fallback-explain" id="fallbackExplain">
      OneRoadTrip est <strong>100% gratuit</strong> et utilise des services d'IA gratuits avec des limites d'utilisation.
    </div>
    
    <div class="fallback-solution">
      <h4 id="fallbackSolutionTitle">Pas de panique ! Import manuel en 3 clics :</h4>
      <ol id="fallbackSteps">
        <li>Ouvrez la page de l'article</li>
        <li>S√©lectionnez tout (<kbd>Ctrl</kbd>+<kbd>A</kbd>) et copiez (<kbd>Ctrl</kbd>+<kbd>C</kbd>)</li>
        <li>Collez dans notre outil d'import gratuit</li>
      </ol>
    </div>
    
    <div class="fallback-actions">
      <a id="fallbackOpenUrl" href="#" target="_blank" class="ort-btn outline">
        üîó Ouvrir l'article
      </a>
      <a href="./import.html" class="ort-btn primary" id="fallbackGoImport">
        üìã Aller √† l'import manuel
      </a>
    </div>
    
    <div class="fallback-error" id="fallbackErrorDetail"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- Config ORT - AJUSTER AVEC VOTRE CONFIG PREPROD -->
<script src="./js/ort-config.js"></script>
<script>
// Fallback si ort-config.js n'est pas charg√©
if (!window.ORT_CONFIG) {
  console.warn('‚ö†Ô∏è ort-config.js non trouv√©, utiliser la config ci-dessous');
  window.ORT_CONFIG = {
    PREPROD: {
      // REMPLACER PAR VOTRE CONFIG PREPROD
      apiKey: "VOTRE_API_KEY",
      authDomain: "oneroadtrip-preprod.firebaseapp.com",
      projectId: "oneroadtrip-preprod",
      storageBucket: "oneroadtrip-preprod.appspot.com",
      messagingSenderId: "VOTRE_SENDER_ID",
      appId: "VOTRE_APP_ID"
    }
  };
}
</script>

<script>
(function() {
  'use strict';
  
  // === LOGS ===
  const logBox = document.getElementById('logBox');
  
  function log(msg, type = 'info') {
    const time = new Date().toLocaleTimeString('fr-FR');
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `<span class="time">[${time}]</span> <span class="${type}">${msg}</span>`;
    logBox.appendChild(entry);
    logBox.scrollTop = logBox.scrollHeight;
    console.log(`[${type.toUpperCase()}]`, msg);
  }
  
  document.getElementById('btnClearLogs').addEventListener('click', () => {
    logBox.innerHTML = '<div class="log-entry"><span class="time">[--:--:--]</span> Logs effac√©s</div>';
  });
  
  // === FIREBASE INIT ===
  const firebaseStatus = document.getElementById('firebaseStatus');
  const userStatus = document.getElementById('userStatus');
  const userInfo = document.getElementById('userInfo');
  const userEmail = document.getElementById('userEmail');
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const btnImportUrl = document.getElementById('btnImportUrl');
  const btnTestFallback = document.getElementById('btnTestFallback');
  
  log('Initialisation Firebase...', 'info');
  
  try {
    // Essayer de charger la config depuis ort-config.js ou utiliser la config hardcod√©e
    const config = window.ORT_CONFIG?.PREPROD || {};
    
    if (!config.apiKey) {
      throw new Error('Config Firebase manquante');
    }
    
    firebase.initializeApp(config);
    firebaseStatus.textContent = '‚úÖ Firebase OK';
    firebaseStatus.className = 'status-item ok';
    log('Firebase initialis√©: ' + config.projectId, 'success');
    
    btnLogin.disabled = false;
    
  } catch (e) {
    firebaseStatus.textContent = '‚ùå Firebase Error';
    firebaseStatus.className = 'status-item error';
    log('Erreur Firebase: ' + e.message, 'error');
    return;
  }
  
  // === AUTH STATE ===
  firebase.auth().onAuthStateChanged((user) => {
    if (user) {
      userStatus.textContent = '‚úÖ Connect√©';
      userStatus.className = 'status-item ok';
      userInfo.classList.add('visible');
      userEmail.textContent = user.email;
      btnLogin.style.display = 'none';
      btnLogout.style.display = '';
      btnImportUrl.disabled = false;
      btnTestFallback.disabled = false;
      log('Utilisateur connect√©: ' + user.email, 'success');
    } else {
      userStatus.textContent = '‚ùå Non connect√©';
      userStatus.className = 'status-item error';
      userInfo.classList.remove('visible');
      btnLogin.style.display = '';
      btnLogout.style.display = 'none';
      btnImportUrl.disabled = true;
      btnTestFallback.disabled = true;
      log('Utilisateur non connect√©', 'info');
    }
  });
  
  // === LOGIN FORM ===
  const loginForm = document.getElementById('loginForm');
  
  btnLogin.addEventListener('click', () => {
    loginForm.style.display = 'block';
    document.getElementById('loginEmail').focus();
  });
  
  document.getElementById('btnCancelLogin').addEventListener('click', () => {
    loginForm.style.display = 'none';
  });
  
  document.getElementById('btnDoLogin').addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
      log('Email et mot de passe requis', 'error');
      return;
    }
    
    log('Tentative de connexion...', 'info');
    
    try {
      await firebase.auth().signInWithEmailAndPassword(email, password);
      loginForm.style.display = 'none';
    } catch (e) {
      log('Erreur connexion: ' + e.message, 'error');
    }
  });
  
  btnLogout.addEventListener('click', async () => {
    await firebase.auth().signOut();
    log('D√©connect√©', 'info');
  });
  
  // === IMPORT URL MODAL ===
  const modal = document.getElementById('importUrlModal');
  const fallbackModal = document.getElementById('importFallbackModal');
  const input = document.getElementById('importUrlInput');
  const status = document.getElementById('importUrlStatus');
  const btnConfirm = document.getElementById('btnConfirmUrl');
  const btnText = btnConfirm.querySelector('.btn-text');
  const btnLoader = btnConfirm.querySelector('.btn-loader');
  const quotaInfo = document.getElementById('urlQuotaInfo');
  
  let currentUrl = '';
  let lastResult = null;
  
  function openModal(m) {
    m.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
  
  function closeModal(m) {
    m.classList.remove('active');
    document.body.style.overflow = '';
  }
  
  // Open modal
  btnImportUrl.addEventListener('click', () => {
    openModal(modal);
    input.value = '';
    status.className = 'ort-status';
    status.textContent = '';
    input.focus();
    log('Modal Import URL ouverte', 'info');
  });
  
  // Close modals
  document.getElementById('btnCancelUrl').addEventListener('click', () => closeModal(modal));
  document.getElementById('btnCloseUrlModal').addEventListener('click', () => closeModal(modal));
  document.getElementById('btnCloseFallback').addEventListener('click', () => closeModal(fallbackModal));
  
  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
  fallbackModal.addEventListener('click', (e) => { if (e.target === fallbackModal) closeModal(fallbackModal); });
  
  // Test Fallback button
  btnTestFallback.addEventListener('click', () => {
    log('Test modal fallback', 'info');
    openFallbackModal('Test erreur simul√©e', 'https://example.com/test-article');
  });
  
  // Confirm import
  btnConfirm.addEventListener('click', async () => {
    const url = input.value.trim();
    currentUrl = url;
    
    if (!url) {
      status.textContent = 'Veuillez entrer une URL';
      status.className = 'ort-status error';
      return;
    }
    
    if (!url.startsWith('http')) {
      status.textContent = 'URL invalide';
      status.className = 'ort-status error';
      return;
    }
    
    // Loading
    btnConfirm.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline';
    status.textContent = '‚è≥ Analyse de la page en cours...';
    status.className = 'ort-status loading';
    log('Appel API parse-url: ' + url, 'info');
    
    try {
      const user = firebase.auth().currentUser;
      const token = await user.getIdToken();
      const lang = document.documentElement.lang || 'fr';
      
      log('Token obtenu, appel Netlify function...', 'info');
      
      const res = await fetch('/.netlify/functions/parse-url', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url, language: lang })
      });
      
      log('R√©ponse re√ßue: ' + res.status, 'info');
      
      const data = await res.json();
      
      if (!data.success) {
        throw new Error(data.error);
      }
      
      lastResult = data;
      
      // Success
      log('‚úÖ Itin√©raire extrait! ' + (data.data.itins[0]?.title || ''), 'success');
      log('Mod√®le utilis√©: ' + (data._meta?.model || 'unknown'), 'info');
      log('Quota restant: ' + data.usage?.remaining, 'info');
      
      if (quotaInfo) {
        quotaInfo.textContent = `${data.usage?.remaining} imports restants ce mois`;
      }
      
      status.textContent = '‚úÖ Itin√©raire extrait !';
      status.className = 'ort-status success';
      
      // Show result
      showResult(data);
      
      // Save to localStorage
      const itin = data.data.itins[0];
      const country = itin.itin_id?.split('::')[0] || 'XX';
      const key = `${country}_${slugify(itin.title || 'trip')}_${Date.now()}`;
      
      localStorage.setItem(`ORT_TEMP_TRIP_${key}_itins`, JSON.stringify(data.data));
      localStorage.setItem(`ORT_TEMP_TRIP_${key}_places`, JSON.stringify(data.places));
      window._lastTripKey = key;
      
      log('Sauvegard√© dans localStorage: ' + key, 'success');
      
      setTimeout(() => closeModal(modal), 1500);
      
    } catch (err) {
      log('‚ùå Erreur: ' + err.message, 'error');
      closeModal(modal);
      openFallbackModal(err.message, currentUrl);
    } finally {
      btnConfirm.disabled = false;
      btnText.style.display = 'inline';
      btnLoader.style.display = 'none';
    }
  });
  
  function openFallbackModal(errorMsg, url) {
    document.getElementById('fallbackOpenUrl').href = url;
    document.getElementById('fallbackErrorDetail').textContent = 'D√©tail technique: ' + errorMsg;
    openModal(fallbackModal);
    log('Modal fallback ouverte', 'info');
  }
  
  function showResult(data) {
    const card = document.getElementById('resultCard');
    const json = document.getElementById('resultJson');
    card.style.display = 'block';
    json.textContent = JSON.stringify(data.data, null, 2);
  }
  
  function slugify(text) {
    return text.toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .substring(0, 50);
  }
  
  // Redirect buttons
  document.getElementById('btnGoDetail').addEventListener('click', () => {
    if (window._lastTripKey) {
      window.location.href = `./roadtrip_detail.html?from=temp&rtKey=${window._lastTripKey}`;
    }
  });
  
  document.getElementById('btnGoEditor').addEventListener('click', () => {
    if (window._lastTripKey) {
      window.location.href = `./roadtrip-editor.html?from=temp&rtKey=${window._lastTripKey}`;
    }
  });
  
  log('Page de test pr√™te', 'success');
  
})();
</script>

</body>
</html>
